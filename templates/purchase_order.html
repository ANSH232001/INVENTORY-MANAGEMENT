<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Purchase Orders List and Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f5f5f5; padding: 20px; }
    .container { max-width: 900px; margin: auto; }
    .pointer { cursor: pointer; }
    #formContainer { background: white; padding: 20px; margin-top: 30px; border-radius: 8px; box-shadow: 0 0 8px rgb(0 0 0 / 0.1); display: none; }
  </style>
  <!-- CHANGED: Include html2pdf.js library from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script> <!-- CHANGED -->
</head>
<body>
  <div class="container">
    <h1>Purchase Orders</h1>
    <table class="table table-hover table-bordered shadow-sm" aria-label="List of Purchase Orders">
      <thead class="table-light">
        <tr>
          <th>PO Number</th>
          <th>GRN Number</th>
          <th>Invoice Number</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="poListBody" aria-live="polite"></tbody>
    </table>

    <div id="formContainer" aria-label="Purchase Order Details">
      <h3>Purchase Order Details</h3>
      <dl class="row">
        <dt class="col-sm-3">PO Number:</dt><dd class="col-sm-9" id="detailPONumber"></dd>
        <dt class="col-sm-3">GRN Number:</dt><dd class="col-sm-9" id="detailGRNNumber"></dd>
        <dt class="col-sm-3">Invoice Number:</dt><dd class="col-sm-9" id="detailInvoiceNumber"></dd>
        <dt class="col-sm-3">Date:</dt><dd class="col-sm-9" id="detailDate"></dd>
      </dl>
      <h4>Products</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Product Name</th>
            <th>Quantity</th>
          </tr>
        </thead>
        <tbody id="productListBody"></tbody>
      </table>
      <button id="printDetails" class="btn btn-primary mb-2">Print</button> <!-- CHANGED: Print button -->
      <button id="closeDetails" class="btn btn-secondary">Close Details</button>
    </div>
  </div>

  <script>
    async function fetchPurchaseOrders() {
      const response = await fetch('/api/purchase_orders');
      if (!response.ok) {
        alert('Failed to load purchase orders.');
        return [];
      }
      return await response.json();
    }

    function renderPOList(purchaseOrders) {
      const tbody = document.getElementById('poListBody');
      tbody.innerHTML = '';
      purchaseOrders.forEach(po => {
        const tr = document.createElement('tr');
        tr.classList.add('pointer');
        tr.tabIndex = 0;
        tr.setAttribute('role', 'button');
        tr.setAttribute('aria-label', `Show details for PO Number ${po.purchase_order_number}`);
        tr.innerHTML = `
          <td>${po.purchase_order_number}</td>
          <td>${po.grn_number}</td>
          <td>${po.invoice_number}</td>
          <td>${po.date}</td>
        `;
        tr.onclick = () => showPODetails(po);
        tr.onkeypress = e => { if (e.key === 'Enter' || e.key === ' ') showPODetails(po); };
        tbody.appendChild(tr);
      });
    }

    function showPODetails(po) {
      document.getElementById('detailPONumber').textContent = po.purchase_order_number;
      document.getElementById('detailGRNNumber').textContent = po.grn_number;
      document.getElementById('detailInvoiceNumber').textContent = po.invoice_number;
      document.getElementById('detailDate').textContent = po.date;

      const productListBody = document.getElementById('productListBody');
      productListBody.innerHTML = '';
      po.items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.product_name}</td>
          <td>${item.quantity}</td>
        `;
        productListBody.appendChild(tr);
      });

      document.getElementById('formContainer').style.display = 'block';
      document.getElementById('formContainer').focus();
    }

    document.getElementById('closeDetails').addEventListener('click', () => {
      document.getElementById('formContainer').style.display = 'none';
    });

    // CHANGED: Add print button click event for PDF generation
    document.getElementById('printDetails').addEventListener('click', () => {
      const element = document.getElementById('formContainer');
      html2pdf()
        .set({
          margin: 10,
          filename: 'purchase_order_details.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        })
        .from(element)
        .save();
    }); // CHANGED

    async function init() {
      const purchaseOrders = await fetchPurchaseOrders();
      renderPOList(purchaseOrders);
    }

    init();
  </script>
</body>
</html>
