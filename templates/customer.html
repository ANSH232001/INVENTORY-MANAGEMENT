<!DOCTYPE html>
<html>
<head>
  <title>Customer Details</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    table { border-collapse: collapse; width: 90%; margin: auto; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: top; }
    th { background-color: #4CAF50; color: white; }
    caption { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; text-align: center;}
    select, input[readonly] {
      width: 100%;
      padding: 8px 6px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    button.delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button.delete-btn svg {
      fill: #d9534f;
      width: 20px;
      height: 20px;
      transition: fill 0.3s ease;
    }
    button.delete-btn:hover svg {
      fill: #a94442;
    }
    button.add-line-btn {
      margin-top: 5px;
      padding: 6px 12px;
      background-color: #008080;
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      box-shadow: 0 3px 6px rgba(0,128,128,0.3);
      transition: background-color 0.3s ease;
      display: inline-block;
    }
    button.add-line-btn:hover {
      background-color: #006666;
    }
  </style>
</head>
<body>

  <table id="productTable">
    <caption>Customer Product Details</caption>
    <thead>
      <tr>
        <th>Select Product</th>
        <th>Product Code</th>
        <th>Name</th>
        <th>Capacity</th>
        <th>Configuration</th>
        <th>Model Name</th>
        <th>Dealer Zone</th>
        <th>Current Stock</th>
        <th>Rate</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr class="data-row">
        <td>
          <select onchange="updateProductDetails(this)" aria-label="Select product">
            <option value="" disabled selected>Select a product</option>
            {% for product in products %}
            <option value="{{ product.product_code }}"
              data-name="{{ product.name }}"
              data-capacity="{{ product.capacity }}"
              data-configuration="{{ product.configuration }}"
              data-model_name="{{ product.model_name }}"
              data-dealer_zone="{{ product.dealer_zone }}"
              data-current_stock="{{ product.current_stock }}"
              data-rate="{{ product.rate }}">
              {{ product.product_code }} - {{ product.name }}
            </option>
            {% endfor %}
          </select>
          <button type="button" class="add-line-btn" onclick="addRowBelow(this)" aria-label="Add a line">Add a Line</button>
        </td>
        <td><input type="text" readonly></td>
        <td><input type="text" readonly></td>
        <td><input type="text" readonly></td>
        <td><input type="text" readonly></td>
        <td><input type="text" readonly></td>
        <td><input type="text" readonly></td>
        <td><input type="text" readonly></td>
        <td><input type="text" readonly></td>
        <td>
          <button type="button" class="delete-btn" onclick="removeRow(this)" aria-label="Delete row">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512" aria-hidden="true" focusable="false">
              <path d="M53.2 467c1.3 25.8 22.5 45 48.6 45h148.3c26.1 0 47.3-19.3 48.6-45L312 128H40l13.2 339zm64.5-210c6.6 0 12 5.4 12 12v128c0 6.6-5.4 12-12 12s-12-5.4-12-12V269c0-6.6 5.4-12 12-12zm96 0c6.6 0 12 5.4 12 12v128c0 6.6-5.4 12-12 12s-12-5.4-12-12V269c0-6.6 5.4-12 12-12zM288 64h-80l-8-16H152l-8 16H64v32h224V64z"/>
            </svg>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <a href="{{ url_for('dashboard') }}" class="button" role="button" aria-label="Back to Dashboard" style="max-width:220px; margin:20px auto; display:block;">Back to Dashboard</a>

<script>
  function updateProductDetails(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const row = selectElement.closest('tr');
    row.querySelectorAll('input').forEach((input, index) => {
      switch (index) {
        case 0: input.value = selectedOption.value || ''; break;              // Product Code
        case 1: input.value = selectedOption.getAttribute('data-name') || ''; break;
        case 2: input.value = selectedOption.getAttribute('data-capacity') || ''; break;
        case 3: input.value = selectedOption.getAttribute('data-configuration') || ''; break;
        case 4: input.value = selectedOption.getAttribute('data-model_name') || ''; break;
        case 5: input.value = selectedOption.getAttribute('data-dealer_zone') || ''; break;
        case 6: input.value = selectedOption.getAttribute('data-current_stock') || ''; break;
        case 7: input.value = selectedOption.getAttribute('data-rate') || ''; break;
      }
    });
  }

  function addRowBelow(button) {
    const currentRow = button.closest('tr');
    const newRow = currentRow.cloneNode(true);

    // Reset the select and inputs in the new row
    const select = newRow.querySelector('select');
    select.selectedIndex = 0;
    newRow.querySelectorAll('input').forEach(input => input.value = '');

    select.onchange = function() { updateProductDetails(this); };

    // Remove add-line button from current row and from cloned row before inserting
    const oldAddBtn = currentRow.querySelector('.add-line-btn');
    if (oldAddBtn) oldAddBtn.remove();

    const newAddBtn = newRow.querySelector('.add-line-btn');
    if (newAddBtn) newAddBtn.remove();

    // Insert the new row right after the current row
    currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);

    // Create a new add-line button and append to the new row's first cell
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'add-line-btn';
    addBtn.textContent = 'Add a Line';
    addBtn.setAttribute('aria-label', 'Add a line');
    addBtn.onclick = function() { addRowBelow(this); };
    newRow.cells[0].appendChild(addBtn);
  }

  function removeRow(button) {
    const tableBody = document.getElementById('tableBody');
    if (tableBody.rows.length > 1) {
      button.closest('tr').remove();
      // If the removed row had the add button, ensure last row has the "Add a Line" button
      if (!document.querySelector('.add-line-btn')) {
        const rows = tableBody.querySelectorAll('tr');
        if (rows.length > 0) {
          const lastRowFirstCell = rows[rows.length -1].cells[0];
          let addBtn = document.createElement('button');
          addBtn.type = 'button';
          addBtn.className = 'add-line-btn';
          addBtn.textContent = 'Add a Line';
          addBtn.setAttribute('aria-label', 'Add a line');
          addBtn.onclick = function() { addRowBelow(this); };
          lastRowFirstCell.appendChild(addBtn);
        }
      }
    } else {
      alert('At least one product line is required.');
    }
  }
</script>

</body>
</html>
